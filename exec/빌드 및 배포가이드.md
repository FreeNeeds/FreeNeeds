# 빌드/배포가이드

## 1. 프로젝트 기술 스택

**Frontend** 

Vue3 version 

Vuex 3.4.0 

CSS3 

JavaScript(ES6) 

HTML5

**Backend** 

SpringBoot 2.7.1 

Gradle 7.4.1 

Spring Security 

Spring data JPA 

Querydsl 

Node.js 

express

**DB** 

MySQL : 8.0.29 Redis

**Server** 

Ubuntu 20.0



## 2. 배포 매뉴얼

## Docker 설치


* 패키지 설치
```
sudo apt update
sudo apt-get install -y ca-certificates \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release
```

* gpg키 다운로드
```
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

* Docker설치
```
sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io docker-compose
```

## Jenkins 설치

* docker-compose.yml 파일 생성
```
sudo vim docker-compose.yml
```

* yml파일 내용입력 후 저장
```
version: '3'

services:
    jenkins:
        image: jenkins/jenkins:lts
        container_name: jenkins
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /jenkins:/var/jenkins_home
        ports:
            - "9090:8080"
        privileged: true
        user: root
```

* yml 파일 실행
```
sudo docker-compose up -d
```

## Jenkins 설정

* Dashboard - 새로운 Item - Freestyle projecㅅ

![새 Item](./img/JenkinsSetting/NewItem.PNG)
![Freestyle project](./img/JenkinsSetting/Freesytle%20project.PNG)

* 소스 코드 관리

![깃 세팅](./img/JenkinsSetting/GitSetting.PNG)
![유저정보 입력](./img/JenkinsSetting/UserInfoSetting.PNG)

Username : 깃랩 아이디

password : 깃랩 패스워드

ID : Credential에서 구별할 이름

![깃 세팅 마무리](./img/JenkinsSetting/GitSetting2.PNG)

* 빌드 유발

![빌드 유발](./img/JenkinsSetting/Build.PNG)
![빌드 유발](./img/JenkinsSetting/Build2.PNG)
웹훅에 복사하기 위해 Generate한 뒤 복사


## GitLab WebHook 연결

![깃랩 웹 훅](./img/JenkinsSetting/GitLabWebhook.PNG)

## Jenkins 도커설치
* jenkins bash shell 접근
```
sudo docker exec -it jenkins bash
```

* 패키지 설치
```
apt update
apt-get install -y ca-certificates \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release
```

* gpg키 다운로드
```
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
    $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
```

* Docker 설치
```
apt update
apt install docker-ce docker-ce-cli containerd.io docker-compose
```

## spring, vue 도커파일 

* backend
```
FROM adoptopenjdk/openjdk12:latest AS builder
WORKDIR /var/jenkins_home/workspace/deply/backend
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod +x ./gradlew
RUN ./gradlew bootJAR

FROM adoptopenjdk/openjdk12:latest
COPY --from=builder /var/jenkins_home/workspace/deply/backend/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

* frontend
```
FROM node:16.15.0 as build-stage
WORKDIR /var/jenkins_home/workspace/deply/frontend
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
FROM nginx:stable-alpine as production-stage
COPY --from=build-stage /var/jenkins_home/workspace/deply/frontend/dist /var/www/html
COPY --from=build-stage /var/jenkins_home/workspace/deply/frontend/deply_conf/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g","daemon off;"]

```

## Jenkins Docker 빌드 설정
* Execute shell 

![Execute shell](./img/JenkinsSetting/ExcuteShell.PNG)


* Execute shell 입력 내용
```
docker image prune -a --force
mkdir -p /var/jenkins_home/images_tar

cd /var/jenkins_home/workspace/deply/frontend/
docker build -t vue .
docker save vue > /var/jenkins_home/images_tar/vue.tar

cd /var/jenkins_home/workspace/deply/backend/
docker build -t spring .
docker save spring > /var/jenkins_home/images_tar/spring.tar

ls /var/jenkins_home/images_tar
```


## Send build artifacts over SSH
* Exec command
```
sudo docker load < /jenkins/images_tar/vue.tar
sudo docker load < /jenkins/images_tar/spring.tar

if (sudo docker ps | grep "vue"); then sudo docker stop vue; fi
if (sudo docker ps | grep "spring"); then sudo docker stop spring; fi

sudo docker run -it -d --rm -p 80:80 -p 443:443 -v /home/ubuntu/certbot/conf:/etc/letsencrypt/ -v /home/ubuntu/certbot/www:/var/www/certbot --name vue vue
echo "Run frontend"
sudo docker run -it -d --rm -p 8080:8080 --name spring spring
echo "Run backend"
```

## Nginx 설정
* 프론트엔드 디렉토리에 nginx.conf파일 생성
```
cd /jenkins/workspace/deply/frontend
sudo mkdir deploy_conf
cd deploy_conf
sudo vim nginx.conf
```

* nginx.conf
```
server{
        listen  80;
        server_name i7b104.p.ssafy.io;
        return 301 https://$host$request_uri;
        index index.html index.html;
}

server{
        listen 443 ssl;
        server_name i7b104.p.ssafy.io;

        ssl_certificate /etc/letsencrypt/live/i7b104.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/i7b104.p.ssafy.io/privkey.pem;

        root /var/www/html;

		index index.html index.htm index.nginx-debian.html;

        location / {
                try_files $uri $uri/ /index.html;
        }

        location /api/v1 {
                proxy_pass http://j7b104.p.ssafy.io:8080;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Host $host;
        }

				location ~ ^/(swagger|webjars|configuration|swagger-resources|v2|csrf){
                proxy_pass http://j7b104.p.ssafy.io:8080;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

		
}

```


